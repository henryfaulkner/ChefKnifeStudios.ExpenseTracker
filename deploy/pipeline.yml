
name: $(SourceBranchName)-expense-tracker-$(Date:yyyyMMdd).$(Rev:r)

trigger:
  branches:
    include:
    - main
    - release/*
    - deploy
pr: none

pool:
  vmImage: ubuntu-latest

variables:
  azure-subscription-service-connection: ChefKnifeStudiosSC
  container-registry: chefknife.azurecr.io
  container-tag: $(Build.BuildNumber)
  container-registry-service-connection: AzureContainerRegistrySC
  api-container-name: chefknifestudios.expensetracker.webapi
  api-container: $(container-registry)/$(api-container-name):$(container-tag)
  migration-container-name: chefknifestudios.expensetracker.data
  migration-container: $(container-registry)/$(migration-container-name):$(container-tag)

stages:
- stage: BuildAndPublish
  displayName: Build and Publish ChefKnifeStudios.ExpenseTracker.WebAPI
  jobs:
  - job: BuildAndPublish
    displayName: Build and Publish ChefKnifeStudios.ExpenseTracker.WebAPI

    variables:
      buildConfiguration: 'Release'

    steps:
    - checkout: self
      persistCredentials: true # Required for git tagging 

    - task: Docker@2
      inputs:
        containerRegistry: '$(container-registry-service-connection)'
        command: 'login'

    - script: |
        docker compose build
      displayName: Docker compose build
      env:
        CONTAINER_REGISTRY: $(container-registry)
        CONTAINER_TAG: $(container-tag)

    - script: |
        docker push $(api-container)
        docker push $(migration-container)
      displayName: Docker push images

- stage: DeployProd
  displayName: Deploy Production
  jobs: 
  - deployment: DeployProd
    displayName: Deploy ChefKnifeStudios.ExpenseTracker.WebAPI to Prod
    environment: 'Prod'
    variables:
    - group: 'Prod-ExpenseTracker'
    strategy:
      runOnce:   
        deploy:
          steps:
          - checkout: self
            persistCredentials: true # Required for git tagging  

          - task: Docker@2
            inputs:
              containerRegistry: '$(container-registry-service-connection)'
              command: 'login'

          # DB Migration
          - script: |
              echo "CONNECTIONSTRINGS__ExpenseTrackerDB=$(CONNECTIONSTRINGS__ExpenseTrackerDB)"
              docker run --rm -e CONNECTIONSTRINGS__ExpenseTrackerDB=$(CONNECTIONSTRINGS__ExpenseTrackerDB) $(migration-container) "$CONNECTIONSTRINGS__ExpenseTrackerDB"
            displayName: 'Run DB Migrations'

          # Deploy API Container App
          - task: AzureContainerApps@1
            displayName: "Deploy API Container App"
            inputs:
              azureSubscription: '$(azure-subscription-service-connection)'
              imageToDeploy: '$(api-container)'
              containerAppName: '$(api-container-name)'
              resourceGroup: 'expense-tracker'
              containerAppEnvironment: 'expense-tracker-api-env'
              environmentVariables: |
                ASPNETCORE_ENVIRONMENT=prod

          # Copy swagger.json from docker
          - script: |
              id=$(docker create $(api-container))
              docker cp $id:/app/swagger.json ./swagger.json
              docker rm -v $id
            displayName: 'Get swagger.json'